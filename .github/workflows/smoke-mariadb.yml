name: Smoke Test MariaDB (pull CI tag)

on:
  workflow_run:
    workflows: ["Build Guacamole Stack images (CI tag)"]
    types: [completed]
  workflow_dispatch: {}

jobs:
  smoke-mariadb:
    name: Smoke test mariadb (guacamole_db existence)
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Show CI tag SHA
        run: |
          echo "Build head sha: ${{ github.event.workflow_run.head_sha }}"
          echo "Using CI tag suffix: ${{ github.event.workflow_run.head_sha }}"

      - name: Pull mariadb CI image
        run: |
          TAG=${{ github.event.workflow_run.head_sha }}
          docker pull ghcr.io/${{ github.repository_owner }}/mariadb-guacamole:ci-$TAG || true

      - name: Run MariaDB container (MYSQL_DATABASE=guacamole_db)
        run: |
          TAG=${{ github.event.workflow_run.head_sha }}
          docker run -d --name smoke-mariadb -e MYSQL_ROOT_PASSWORD=rootpassword -e MYSQL_DATABASE=guacamole_db ghcr.io/${{ github.repository_owner }}/mariadb-guacamole:ci-$TAG

      - name: Wait for MariaDB readiness
        run: |
          for i in $(seq 1 40); do
            docker exec smoke-mariadb mysqladmin ping -uroot -prootpassword --silent >/dev/null 2>&1 && break || true
            echo "Waiting for MariaDB... ($i)"
            sleep 2
          done
          docker exec smoke-mariadb mysqladmin ping -uroot -prootpassword --silent >/dev/null 2>&1 || { echo "MariaDB not ready"; docker logs smoke-mariadb; exit 1; }

      - name: Check guacamole_db existence
        run: |
          docker exec smoke-mariadb mysql -uroot -prootpassword -e "SHOW DATABASES LIKE 'guacamole_db';" | grep -q guacamole_db \
            && echo "Database guacamole_db exists" \
            || (echo "Database guacamole_db NOT found" && docker logs smoke-mariadb && exit 1)

      - name: Cleanup
        if: always()
        run: |
          docker rm -f smoke-mariadb || true
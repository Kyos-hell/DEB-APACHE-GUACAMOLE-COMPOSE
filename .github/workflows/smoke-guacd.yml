name: Smoke Test guacd (pull CI tag)

on:
  workflow_run:
    workflows: ["Build Guacamole Stack images (CI tag)"]
    types: [completed]
  workflow_dispatch: {}

jobs:
  smoke-guacd:
    name: Smoke test guacd (port 4822 + process)
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Show CI tag SHA
        run: |
          echo "Using CI tag suffix: ${{ github.event.workflow_run.head_sha }}"

      - name: Pull guacd CI image
        run: |
          TAG=${{ github.event.workflow_run.head_sha }}
          docker pull ghcr.io/${{ github.repository_owner }}/guacd:ci-$TAG || true

      - name: Run guacd container
        run: docker run -d --name smoke-guacd guacd:ci-${{ github.event.workflow_run.head_sha }}

      - name: Wait and verify process
        run: |
          sleep 5
          docker ps --filter "name=smoke-guacd" --format "{{.Names}}" | grep -q smoke-guacd \
            && echo "guacd container running" \
            || (echo "guacd container not running" && docker logs smoke-guacd && exit 1)

      - name: Install net-tools inside container (if apt available)
        run: |
          docker exec smoke-guacd sh -c 'if command -v apt-get >/dev/null 2>&1; then DEBIAN_FRONTEND=noninteractive apt-get update >/dev/null && apt-get install -y --no-install-recommends net-tools >/dev/null || true; else echo "apt-get not available"; fi'

      - name: Check port 4822 listening
        run: |
          docker exec smoke-guacd sh -c "netstat -ltn | grep -q ':4822' && echo 'Port 4822 listening' || (echo 'Port 4822 not listening ‚ùå'; docker logs smoke-guacd; exit 1)"

      - name: Cleanup
        if: always()
        run: docker rm -f smoke-guacd || true
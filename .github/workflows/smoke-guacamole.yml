name: Smoke test Guacamole (pull CI tag)

on:
  workflow_run:
    workflows: ["Build Guacamole Stack images (CI tag)"]
    types: [completed]
  workflow_dispatch: {}

jobs:
  smoke-guacamole:
    name: Smoke Guacamole stack (HTTP + DB + optional login)
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Identify image tag (sha)
        run: |
          echo "WORKFLOW_SHA=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_ENV
          echo "Using CI tag suffix: ${WORKFLOW_SHA}"

      - name: Pull images from GHCR
        run: |
          TAG=${{ github.event.workflow_run.head_sha }}
          docker pull ghcr.io/${{ github.repository_owner }}/mariadb-guacamole:ci-$TAG || true
          docker pull ghcr.io/${{ github.repository_owner }}/guacd:ci-$TAG || true
          docker pull ghcr.io/${{ github.repository_owner }}/guacamole:ci-$TAG || true

      - name: Create network (idempotent)
        run: |
          docker network inspect guacnet >/dev/null 2>&1 || docker network create guacnet

      - name: Start MariaDB + guacd (support)
        run: |
          TAG=${{ github.event.workflow_run.head_sha }}
          docker run -d --name smoke-mariadb --network guacnet \
            -e MYSQL_ROOT_PASSWORD=rootpassword \
            -e MYSQL_DATABASE=guacamole_db \
            -e MYSQL_USER=guacamole_user \
            -e MYSQL_PASSWORD=some_password \
            ghcr.io/${{ github.repository_owner }}/mariadb-guacamole:ci-$TAG
          docker run -d --name smoke-guacd --network guacnet ghcr.io/${{ github.repository_owner }}/guacd:ci-$TAG

      - name: Wait for MariaDB readiness
        run: |
          for i in $(seq 1 40); do
            docker exec smoke-mariadb mysqladmin ping -uroot -prootpassword --silent >/dev/null 2>&1 && break || true
            echo "Waiting MariaDB... ($i)"
            sleep 2
          done
          docker exec smoke-mariadb mysqladmin ping -uroot -prootpassword --silent >/dev/null 2>&1 || { echo "MariaDB not ready"; docker logs smoke-mariadb; exit 1; }

      - name: Start Guacamole container
        run: |
          TAG=${{ github.event.workflow_run.head_sha }}
          docker run -d --name smoke-guac --network guacnet -p 8080:8080 \
            -e GUACD_HOST=smoke-guacd \
            -e MYSQL_HOST=smoke-mariadb \
            -e MYSQL_DATABASE=guacamole_db \
            -e MYSQL_USER=guacamole_user \
            -e MYSQL_PASSWORD=some_password \
            ghcr.io/${{ github.repository_owner }}/guacamole:ci-$TAG

      - name: Wait for Guacamole HTTP (context path)
        run: |
          for i in $(seq 1 60); do
            if curl -sS -f http://localhost:8080/guacamole/ >/dev/null 2>&1; then
              echo "HTTP context /guacamole/ ready at attempt $i"
              break
            fi
            echo "Waiting Guacamole... ($i)"
            sleep 2
          done
          curl -sS -f http://localhost:8080/guacamole/ >/dev/null 2>&1 || { echo "Guacamole not responding"; docker logs smoke-guac; exit 1; }
          echo "Guacamole HTTP reachable"

      - name: Check if schema present (guacamole_user)
        id: schema
        run: |
          if docker exec smoke-mariadb mysql -uroot -prootpassword -e "USE guacamole_db; SHOW TABLES LIKE 'guacamole_user';" | grep -q guacamole_user; then
            echo "has_schema=true" >> $GITHUB_OUTPUT
            echo "Schema presence detected"
          else
            echo "has_schema=false" >> $GITHUB_OUTPUT
            echo "Schema NOT detected"
          fi

      - name: Attempt login (guacadmin) with retries (only if schema present)
        if: ${{ steps.schema.outputs.has_schema == 'true' }}
        run: |
          set -euo pipefail
          LOGIN_OK=0
          for i in $(seq 1 15); do
            resp=$(curl -sS -H 'Content-Type: application/x-www-form-urlencoded' -X POST http://localhost:8080/guacamole/api/tokens --data 'username=guacadmin&password=guacadmin' || true)
            echo "Try $i -> $resp"
            echo "$resp" | grep -q '"authToken"' && { LOGIN_OK=1; break; }
            sleep 2
          done
          if [ "$LOGIN_OK" -eq 1 ]; then
            echo "Login token obtained"
          else
            echo "Login failed after retries"
            docker logs smoke-guac | tail -n 200 || true
            exit 1
          fi

      - name: Dump logs on failure
        if: ${{ failure() }}
        run: |
          docker logs smoke-guac || true
          docker logs smoke-mariadb || true
          docker logs smoke-guacd || true

      - name: Cleanup
        if: always()
        run: |
          docker rm -f smoke-guac smoke-mariadb smoke-guacd || true
          docker network rm guacnet || true